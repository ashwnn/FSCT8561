import requests

BASE_URL = "http://vm-ubuntu:3000"
TIMEOUT = 10

XSS_PAYLOADS = [
    "<script>alert(1)</script>",
    "<u>test</u>",
]

SQLI_PAYLOADS = [
    "'",
    "--",
    "') OR 1=1--",
]

SQL_ERROR_STRINGS = [
    "SQLITE_ERROR",
]

SECURITY_HEADERS = [
    "Content-Security-Policy",
    "Strict-Transport-Security",
    "X-Content-Type-Options",
]


def full_url(path: str) -> str:
    return BASE_URL.rstrip("/") + path


def safe_get(session: requests.Session, path: str, params: dict):
    try:
        return session.get(full_url(path), params=params, timeout=TIMEOUT)
    except requests.RequestException:
        return None


def safe_post(session: requests.Session, path: str, body: dict):
    try:
        return session.post(full_url(path), json=body, timeout=TIMEOUT)
    except requests.RequestException:
        return None


def add_alert(seen: set, bucket: list, key: tuple, message: str) -> None:
    # Avoid duplicate alerts
    if key in seen:
        return
    seen.add(key)
    bucket.append(message)


def has_sql_indicator(resp) -> bool:
    if resp is None:
        return False

    if resp.status_code >= 500:
        return True

    low = resp.text.lower()
    for s in SQL_ERROR_STRINGS:
        if s.lower() in low:
            return True

    return False


def main() -> None:
    print("=" * 50)
    print("[INFO] Starting vulnerability detector")
    print(f"[INFO] Target: {BASE_URL}")
    print("=" * 50)

    s = requests.Session()

    seen = set()
    xss_hits = []
    sql_hits = []
    config_hits = []

    # Config checks on /
    base = safe_get(s, "/", {})
    if base is None:
        print("[ERROR] Could not reach target. Is Juice Shop running on localhost:3000?")
        return

    for h in SECURITY_HEADERS:
        if h not in base.headers:
            add_alert(seen, config_hits, ("CONFIG", "/", h), f"Low Severity: missing header {h} on /")

    # XSS checks on /rest/products/search
    for payload in XSS_PAYLOADS:
        r = safe_get(s, "/rest/products/search", {"q": payload})
        if r is None:
            continue

        # Check for exact string "<script>"
        if "<script>" in r.text:
            add_alert(
                seen,
                xss_hits,
                ("XSS", "/rest/products/search", payload),
                f"[ALERT] XSS indicator: /rest/products/search reflected <script> for q={payload}",
            )

    # SQL checks on /rest/products/search
    for payload in SQLI_PAYLOADS:
        r = safe_get(s, "/rest/products/search", {"q": payload})
        if has_sql_indicator(r):
            add_alert(
                seen,
                sql_hits,
                ("SQLI", "/rest/products/search", payload),
                f"[ALERT] SQL indicator: /rest/products/search with q={payload}",
            )

    # SQL checks on /rest/user/login
    for payload in SQLI_PAYLOADS:
        body = {"email": "test@test.com" + payload, "password": "test123"}
        r = safe_post(s, "/rest/user/login", body)
        if has_sql_indicator(r):
            add_alert(
                seen,
                sql_hits,
                ("SQLI", "/rest/user/login", body["email"]),
                f"[ALERT] SQL indicator: /rest/user/login with email={body['email']}",
            )

    # Summary (concise)
    print("=" * 50)
    print("Summary")
    print("=" * 50)

    print(f"XSS findings: {len(xss_hits)}")
    for item in xss_hits:
        print(item)

    print(f"SQL findings: {len(sql_hits)}")
    for item in sql_hits:
        print(item)

    print(f"Config findings: {len(config_hits)}")
    for item in config_hits:
        print(item)

    print("=" * 50)
    print("[INFO] Done")


if __name__ == "__main__":
    main()
